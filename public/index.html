<!DOCTYPE html>
<html>

<head>

    <title>South Carolina School Explorer</title>
    <meta name="author" content="Aadit Tambe & Kara Newhouse">

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" /> -->

    <link rel="stylesheet" href="https://use.typekit.net/kdc4trt.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.4/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="static/search.css">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
<div id="container">
    <div id="title">
        <h1>South Carolina <span>Schools</span> Explorer</h1>
    </div> <!-- close title -->

    <div class="app-search">
        <div class="search-row">
            <input id="fill-box" type="text" placeholder="Search school or district ...">
            <i class="fa fa-search"></i>
        </div>
        <div class="search-eg">
            <p>For example: </p>
            <p><a href="/district/160999/">Abbeville County School District</a></p>
            <p><a href="/school/403024/">Iva Elementary School</a></p>
            <p><a href="/school/4201002/">Chapman High School</a></p>
        </div>
        <div id="suggestions-list" class="list-items"></div>
    </div>

    <div id='map' class="map-border"></div>

    <h1>School Data</h1>
    <table border=1 cellpadding=7 id="data" class="table table-striped">
        <thead>
        <tr>
            <th>Name</th>
            <th>Education Level</th>
            <th>Graduation Rate</th>
            <th>Avg ACT Score</th>
            <th>Avg Teacher Salary</th>
            <th>3-Yr Teacher Retention</th>
        </tr>
        </thead>
        <tbody>
        {% for school in school_object_list %}

        <tr>
            <td><a href="school/{{ school.school_id }}/">{{ school.school }}</a></td>

            {% if school.type_y == 'H' %}
            <td>High School</td>
            {% elif school.type_y == 'M' %}
            <td>Middle School</td>
            {% elif school.type_y == 'E' %}
            <td>Elementary School</td>
            {% else %}
            <td>N/A</td>
            {% endif %}

            {% if school.gpercent_overall|float|round(1) > 0 %}
            <td>{{ school.gpercent_overall|float|round(1) }}%</td>
            {% else %}
            <td></td>
            {% endif %}

            {% if school.act_avg_composite_score|float > 0 %}
            <td>{{ school.act_avg_composite_score }}</td>
            {% else %}
            <td></td>
            {% endif %}

            {% if school.tchsalary_avg_curr_yr|int|round(1) > 0 %}
            <td>${{ format_comma(school.tchsalary_avg_curr_yr|int|round(1)) }}</td>
            {% else %}
            <td></td>
            {% endif %}

            {% if school.tchreturn3yr_avg_pct_curr_yr|float|round(1) > 0 %}
            <td>{{ school.tchreturn3yr_avg_pct_curr_yr|float|round(1) }}%</td>
            {% else %}
            <td></td>
            {% endif %}
        </tr>

        {% endfor %}
        </tbody>
    </table>




</div><!-- close container -->

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/chroma-js@2.1.2/chroma.js"></script>

<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.11.4/js/jquery.dataTables.min.js"></script>

<!-- <-- fuse js -->
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.1"></script>

<!-- load d3 -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- <-- search script -->
<script src="static/search.js"></script>

<!-- TEMP -->
<script>
    searchApp("home")
</script>

<!-- leaflet map script -->
<script>
    d3.json("static/district_demographic_join_new.geojson").then(function (loadedData) {


        var map = L.map('map', {
            minZoom: 7,
            maxZoom: 10,
        }).setView([33.4, -81.1], 7);


        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYWFkaXR0YW1iZSIsImEiOiJja3R2eDFjZjMyZXJxMnhwcTR0Y3F5eGk2In0.9AAyIXkTkCMcZ8NNlDPB9g', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/light-v9',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        function getColorGraduationRate(d) {
            const scale = chroma.scale('OrRd').domain([0, 100]).classes([0, 50.1, 60.1, 70.1, 80.1, 90.1, 100])
            return scale(d).hex();
        }

        function getColorACT(d) {
            const scale = chroma.scale('YlGn').domain([0, 32]).classes([0, 10.1, 13.1, 16.1, 19.1, 22.1, 32])
            return scale(d).hex();
        }

        function getColorTeacherSalary(d) {
            const scale = chroma.scale('RdPu').domain([45000, 57000]).classes([0, 45000.1, 48000.1, 51000.1, 54000.1, 57000]);
            return scale(d).hex();
        }

        function getColorTeacherRetention(d) {
            const scale = chroma.scale('PuBu').domain([0, 100]).classes([0, 60.1, 70.1, 80.1, 90.1, 100])
            return scale(d).hex();
        }

        function style(feature) {
            var property = parseFloat((feature.properties.gpercent_overall)).toFixed(0);
            // console.log(property)
            return {
                fillColor: getColorGraduationRate(property),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function formatComma(float){
            num = Math.round(float);
            return num.toLocaleString("en-US");
        }


        function onEachFeature(feature, layer) {
            layer.bindPopup("<p style = \"text-align:center;\">" + '<strong>' + '<a href=' + "district/" + feature.properties.district_id + ">" + feature.properties.LEA_NAME + '</a></strong>' + " <br> Graduation Rate: " + parseFloat((feature.properties.gpercent_overall)).toFixed(0) + '%');
        }

        var geojsonLayer = new L.geoJson(loadedData, { onEachFeature: onEachFeature, style: style });

        geojsonLayer.addTo(map);

        var graduationLegend = L.control({ position: 'bottomright' });

        graduationLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [100, 90, 80, 70, 60],
                labels = [];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColorGraduationRate(grades[i]) + '"></i> ' +
                    grades[i] + '%' + (grades[i + 1] ? ' - ' + (grades[i + 1] + .1) + '%<br>' : ' and less');
            }

            return div;
        };

        var actLegend = L.control({ position: 'bottomright' });

        actLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [32, 22, 19, 16, 13],
                labels = [];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColorACT(grades[i]) + '"></i> ' +
                    (grades[i]) + (grades[i + 1] ? ' - ' + (grades[i + 1] + .1) + '<br>' : ' and less');
            }

            return div;
        };

        var teacherSalaryLegend = L.control({ position: 'bottomright' });

        teacherSalaryLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [57000, 54000, 51000, 48000],
                labels = [];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColorTeacherSalary(grades[i]) + '"></i> $'
                    + grades[i].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
                    + (grades[i + 1] ? ' - $' + grades[i + 1].toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + '<br>' : ' and less');
            }

            return div;
        };

        var teacherRetentionLegend = L.control({ position: 'bottomright' });

        teacherRetentionLegend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend'),
                grades = [100, 90, 80, 70],
                labels = [];

            for (var i = 0; i < grades.length; i++) {
                div.innerHTML +=
                    '<i style="background:' + getColorTeacherRetention(grades[i]) + '"></i> ' +
                    grades[i] + '%' + (grades[i + 1] ? ' - ' + grades[i + 1] + '%<br>' : ' and less');
            }

            return div;
        };


        var currentLegend = graduationLegend;

        var buttons = L.control({ position: 'topright' });

        buttons.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = '<div><button class="select1 active">Graduation Rate</button><button class="select1">Avg ACT Score</button><button class="select1">Avg Teacher Salary</button><button class="select1">3-Yr Teacher Retention</button></div>';
            div.firstChild.onmousedown = div.firstChild.ondblclick = L.DomEvent.stopPropagation;
            return div;
        }

        buttons.addTo(map)

        $('.select1').click(function () {
            $('.select1').css("background-color", "#F3F4F2")
            $('.select1').css("color", "#262B28")
            $(this).css("background-color", "#262B28")
            $(this).css("color", "#F3F4F2")

            var property;

            if (this.innerText == "Graduation Rate") {
                property = 'gpercent_overall';

            }
            else if (this.innerText == "Avg ACT Score") {
                property = "act_avg_composite_score";
            }

            else if (this.innerText == "Avg Teacher Salary") {
                property = "tchsalary_avg_curr_yr";
            }

            else if (this.innerText == "3-Yr Teacher Retention") {
                property = "tchreturn3yr_avg_pct_curr_yr";

            }

            function styleTotal(feature) {

                property2 = parseFloat(feature['properties'][property]).toFixed(1);

                return {
                    fillColor: getColorGraduationRate(property2),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }

            function styleACT(feature) {

                property2 = parseFloat(feature['properties'][property]).toFixed(1);

                return {
                    fillColor: getColorACT(property2),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }

            function styleTeacherSalary(feature) {

                property2 = parseFloat(feature['properties'][property]).toFixed(1);

                return {
                    fillColor: getColorTeacherSalary(property2),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }

            function styleTeacherRetention(feature) {

                property2 = parseFloat(feature['properties'][property]).toFixed(1);

                return {
                    fillColor: getColorTeacherRetention(property2),
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    dashArray: '3',
                    fillOpacity: 0.7
                };
            }


            function onEachFeature2(feature, layer) {
                var updatedProperty

                if (property == "gpercent_overall") {
                    updatedProperty = "Graduation Rate"
                }

                if (property == "tchsalary_avg_curr_yr") {
                    updatedProperty = "Avg Teacher Salary"
                }
                else if (property == "act_avg_composite_score") {
                    updatedProperty = "Avg ACT Score"
                }
                else if (property == "tchreturn3yr_avg_pct_curr_yr") {
                    updatedProperty = "3-Yr Teacher Retention"
                }

                if (isNaN(feature['properties'][property]) == true) {
                    layer.bindPopup("<p style = \"text-align:center;\">" + '<strong>' + feature.properties.LEA_NAME + '</strong>' + " <br>" + "Note: " + 'no data' + "</p>");
                } else {
                    if (updatedProperty === 'Graduation Rate' || updatedProperty === '3-Yr Teacher Retention') {
                        layer.bindPopup(`<p style = \"text-align:center;\"><strong><a href="district/${feature.properties.district_id}">${feature.properties.LEA_NAME}</a></strong><br>${updatedProperty}: ${parseFloat((feature['properties'][property])).toFixed(0)}%`)
                    }
                    else if (updatedProperty === 'Avg ACT Score') {
                        layer.bindPopup(`<p style = \"text-align:center;\"><strong><a href="district/${feature.properties.district_id}">${feature.properties.LEA_NAME}</a></strong><br>${updatedProperty}: ${parseFloat((feature['properties'][property])).toFixed(1)}`)
                    }
                    else if (updatedProperty === "Avg Teacher Salary") {
                        layer.bindPopup(`<p style = \"text-align:center;\"><strong><a href="district/${feature.properties.district_id}">${feature.properties.LEA_NAME}</a></strong><br>${updatedProperty}: $${parseFloat((feature['properties'][property])).toFixed(0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`)
                    }
                }
            }

            if (this.innerText == "Graduation Rate") {

                map.removeLayer(geojsonLayer);
                geojsonLayer = new L.geoJson(loadedData, { onEachFeature: onEachFeature2, style: styleTotal });
                geojsonLayer.addTo(map);

                map.removeControl(currentLegend);
                currentLegend = graduationLegend;
                graduationLegend.addTo(map);

            }

            else if (this.innerText == "Avg Teacher Salary") {

                map.removeLayer(geojsonLayer);
                geojsonLayer = new L.geoJson(loadedData, { onEachFeature: onEachFeature2, style: styleTeacherSalary });
                geojsonLayer.addTo(map);

                map.removeControl(currentLegend);
                currentLegend = teacherSalaryLegend;
                teacherSalaryLegend.addTo(map);

            }

            else if (this.innerText == "Avg ACT Score") {

                map.removeLayer(geojsonLayer);
                geojsonLayer = new L.geoJson(loadedData, { onEachFeature: onEachFeature2, style: styleACT });
                geojsonLayer.addTo(map);

                map.removeControl(currentLegend);
                currentLegend = actLegend;
                actLegend.addTo(map);

            }


            else if (this.innerText == "3-Yr Teacher Retention") {

                map.removeLayer(geojsonLayer);
                geojsonLayer = new L.geoJson(loadedData, { onEachFeature: onEachFeature2, style: styleTeacherRetention });
                geojsonLayer.addTo(map);

                map.removeControl(currentLegend);
                currentLegend = teacherRetentionLegend;
                teacherRetentionLegend.addTo(map);

            }

        })
        map.attributionControl.addAttribution('Population data &copy; <a href="http://census.gov/">US Census Bureau</a>');
        currentLegend.addTo(map);
    });


</script>

<!-- DataTables script -->
<script>
    $(document).ready(function () {
        $('#data').DataTable({
            "order": [[2, "desc"]],
        });
    });
</script>
</body>

</html>
